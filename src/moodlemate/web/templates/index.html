<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moodle Mate - Dashboard</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="icon" href="/static/icon.svg" type="image/svg+xml">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        background: "var(--color-bg)",
                        "card-bg": "var(--color-card)",
                        border: "var(--color-border)",
                        "border-hover": "var(--color-border-hover)",
                        primary: "var(--color-text)",
                        secondary: "var(--color-text-secondary)",
                        tertiary: "var(--color-text-tertiary)",
                        accent: "var(--color-accent)",
                        "accent-muted": "var(--color-accent-muted)",
                        "accent-contrast": "var(--color-accent-contrast)",
                        success: "var(--color-success)",
                        danger: "var(--color-danger)",
                        input: "var(--color-input)"
                    },
                    fontFamily: {
                        sans: ["Inter", "sans-serif"],
                        mono: ["JetBrains Mono", "monospace"]
                    },
                    fontSize: {
                        xs: "11px",
                        sm: "12px",
                        base: "13px",
                        lg: "14px",
                        xl: "16px",
                        "2xl": "20px"
                    },
                    animation: {
                        "fade-in": "fadeIn 0.3s ease-out forwards"
                    },
                    keyframes: {
                        fadeIn: {
                            "0%": { opacity: "0", transform: "translateY(5px)" },
                            "100%": { opacity: "1", transform: "translateY(0)" }
                        }
                    }
                }
            }
        };
    </script>

    <style>
        :root {
            --color-bg: #14120B;
            --color-card: #1B1913;
            --color-border: #2D281D;
            --color-border-hover: #3A3426;
            --color-text: #E8E2D4;
            --color-text-secondary: #A89E8F;
            --color-text-tertiary: #7F7566;
            --color-accent: #F4B860;
            --color-accent-muted: #DFA851;
            --color-accent-contrast: #1A1510;
            --color-input: #1E1A13;
            --color-success: #10B981;
            --color-danger: #4E1F1F;
            --color-scroll-track: #14120B;
            --color-scroll-thumb: #333333;
            --color-scroll-thumb-hover: #4d4d4d;
        }

        [x-cloak] { display: none !important; }
        body {
            background-color: var(--color-bg);
            color: var(--color-text);
            font-family: "Inter", sans-serif;
            -webkit-font-smoothing: antialiased;
        }
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: var(--color-scroll-track); }
        ::-webkit-scrollbar-thumb { background: var(--color-scroll-thumb); border-radius: 5px; border: 2px solid var(--color-bg); }
        ::-webkit-scrollbar-thumb:hover { background: var(--color-scroll-thumb-hover); }
        .expand-content {
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            overflow: hidden;
            max-height: 0;
            opacity: 0;
        }
        .expand-content.open {
            max-height: 500px;
            opacity: 1;
        }
        .toggle-track {
            width: 42px;
            height: 22px;
            border-radius: 999px;
            border: 1px solid var(--color-border);
            background: var(--color-input);
            display: inline-flex;
            align-items: center;
            padding: 0 3px;
            transition: background 0.25s ease, border-color 0.25s ease;
            position: relative;
            box-sizing: border-box;
        }
        .toggle-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--color-text);
            transition: transform 0.25s ease;
        }
        input:checked + .toggle-track {
            background: var(--color-accent);
            border-color: var(--color-accent);
        }
        input:checked + .toggle-track .toggle-thumb {
            transform: translateX(18px);
        }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="flex h-screen overflow-hidden text-base bg-background text-primary" x-data="dashboard()" x-init="init()">

    <aside class="w-[240px] flex-shrink-0 flex flex-col border-r border-border h-full bg-background pt-6 pb-4 px-4 overflow-y-auto text-primary z-20">
        <div class="mb-8 pl-2 flex items-center gap-2 text-primary">
            <img src="/static/icon.svg" alt="Moodle Mate Logo" class="w-8 h-8">
            <span class="font-medium text-lg tracking-tight text-primary">Moodle Mate</span>
        </div>

        <div class="mb-6 pl-2">
            <div class="font-medium text-primary flex items-center gap-1">
                Admin <span class="text-tertiary text-[10px]">↗</span>
            </div>
        </div>

        <nav class="flex flex-col gap-1 mb-6">
            <a href="#overview" class="flex items-center gap-2.5 px-2 py-1.5 rounded-md text-primary bg-white/5 transition-all duration-150 text-left">
                <svg class="w-4 h-4 opacity-80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
                Dashboard
            </a>
        </nav>

        <div class="mt-auto pl-2">
            <button @click="logout" class="flex items-center gap-2 text-tertiary hover:text-danger-text cursor-pointer transition-colors text-xs w-full text-left">
                <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
                Log Out
            </button>
        </div>
    </aside>

    <main class="flex-1 h-full overflow-y-auto bg-background text-primary scroll-smooth">
        <div class="max-w-[1100px] mx-auto px-8 lg:px-16 py-12 flex flex-col gap-12">

            <section id="overview" class="flex flex-col gap-6 animate-fade-in">
                <div class="flex flex-wrap items-end justify-between border-b border-white/5 pb-6 gap-4">
                    <div>
                        <h1 class="text-3xl font-medium mb-1 text-primary">Dashboard</h1>
                        <p class="text-secondary text-sm">Monitoring Moodle instance notifications</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="relative" x-data="{ open: false }">
                            <button @click="open = !open" @click.outside="open = false" class="w-9 h-9 rounded-full border border-border bg-card-bg text-secondary hover:text-primary hover:bg-border/20 flex items-center justify-center transition-colors" title="Switch theme">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v3m0 12v3m9-9h-3M6 12H3m15.364-6.364l-2.121 2.121M8.757 15.243l-2.12 2.121m12.727 0l-2.121-2.121M8.757 8.757l-2.12-2.121"></path></svg>
                            </button>
                            <div x-show="open" x-transition class="absolute right-0 mt-2 w-44 bg-card-bg border border-border rounded-2xl shadow-lg py-2 z-50">
                                <div class="px-3 pb-2 text-[10px] font-semibold text-tertiary uppercase tracking-[0.2em]">Theme</div>
                                <template x-for="(label, key) in themeNames" :key="key">
                                    <button @click="setTheme(key); open = false" class="w-full flex items-center justify-between px-3 py-2 text-sm transition-colors hover:bg-border/30" :class="currentTheme === key ? 'text-accent font-medium' : 'text-secondary'">
                                        <span x-text="label"></span>
                                        <svg x-show="currentTheme === key" class="w-4 h-4 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                                    </button>
                                </template>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 px-2 py-1">
                            <span class="relative flex h-2 w-2">
                                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-success opacity-75"></span>
                                <span class="relative inline-flex rounded-full h-2 w-2 bg-success"></span>
                            </span>
                            <span class="text-xs text-success uppercase tracking-wider font-medium" x-text="status.running ? 'Operational' : 'Idle'"></span>
                        </div>
                        <button @click="refreshData" class="p-1.5 rounded hover:bg-white/10 text-secondary hover:text-primary transition-colors active:scale-95 duration-150" :class="{'animate-spin': loading}" title="Refresh">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                        </button>
                    </div>
                </div>

                <div class="flex flex-wrap gap-12 py-2">
                    <div class="flex flex-col">
                        <h4 class="text-tertiary text-xs mb-1 uppercase tracking-wide">Last ID Processed</h4>
                        <div class="text-2xl font-medium text-primary font-mono" x-text="status.last_notification_id || '---'"></div>
                    </div>
                    <div class="flex flex-col">
                        <h4 class="text-tertiary text-xs mb-1 uppercase tracking-wide">Fetch Interval</h4>
                        <div class="text-2xl font-medium text-primary">
                            <span x-text="config.notification.fetch_interval || 60"></span>
                            <span class="text-tertiary text-sm font-normal">sec</span>
                        </div>
                    </div>
                    <div class="flex flex-col">
                        <h4 class="text-tertiary text-xs mb-1 uppercase tracking-wide">Target URL</h4>
                        <div class="text-base text-secondary font-mono pt-1 truncate max-w-[280px]" x-text="config.moodle.url || 'Not configured'"></div>
                    </div>
                </div>

                <div class="bg-card-bg border border-border rounded-lg p-5 flex flex-wrap items-center justify-between gap-4 shadow-sm">
                    <div>
                        <div class="text-lg font-medium mb-1 text-primary">Test Notification</div>
                        <p class="text-secondary text-sm">Trigger a manual check and payload delivery.</p>
                    </div>
                    <button @click="triggerTestNotification" :disabled="loading" class="bg-accent text-accent-contrast border border-border px-4 py-1.5 rounded-full text-sm font-medium tracking-wide hover:bg-accent-muted active:scale-95 transition-all disabled:opacity-50 disabled:scale-100">
                        <span x-show="!loading" class="flex items-center gap-2">
                            <span>Send Now</span>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                        </span>
                        <span x-show="loading">Sending...</span>
                    </button>
                </div>

                <div>
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-medium text-primary">Recent Activity</h3>
                        <span class="text-secondary text-xs" x-text="history.length + ' entries'"></span>
                    </div>
                    <div class="bg-card-bg border border-border rounded-lg overflow-hidden">
                        <template x-for="(item, index) in history" :key="item.timestamp ?? index">
                            <div class="border-b border-white/5 last:border-0 transition-colors">
                                <div @click="toggleExpand(index)" class="flex justify-between items-center px-5 py-4 cursor-pointer group">
                                    <div class="flex items-start gap-3">
                                        <div class="mt-1 text-tertiary transition-transform duration-300" :class="expandedId === index ? 'rotate-90 text-primary' : ''">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
                                        </div>
                                        <div>
                                            <div class="text-base font-medium text-primary transition-colors group-hover:text-white" x-text="item.subject || 'Notification'"></div>
                                            <div class="text-xs text-tertiary mt-0.5">
                                                ID: <span class="font-mono" x-text="item.id || '---'"></span>
                                                • <span x-text="formatDate(item.timestamp)"></span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex gap-2 items-center">
                                        <template x-for="provider in item.providers || []" :key="provider">
                                            <span class="text-[10px] px-1.5 py-0.5 border border-border rounded text-secondary" x-text="provider"></span>
                                        </template>
                                        <span x-show="!item.providers || !item.providers.length" class="text-secondary text-[10px]">None</span>
                                    </div>
                                </div>
                                <div class="expand-content bg-background border-t border-white/5" :class="expandedId === index ? 'open' : ''">
                                    <div class="p-5 pl-12 space-y-4">
                                        <div>
                                            <div class="text-xs text-tertiary uppercase tracking-wider mb-1">Message</div>
                                            <div class="text-sm text-primary whitespace-pre-wrap leading-relaxed" x-text="item.message || 'No message captured.'"></div>
                                        </div>

                                        <div x-show="item.summary">
                                            <div class="text-xs text-tertiary uppercase tracking-wider mb-1">Summary</div>
                                            <div class="text-sm text-secondary whitespace-pre-wrap leading-relaxed" x-text="item.summary"></div>
                                        </div>

                                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                            <div>
                                                <div class="text-[10px] text-tertiary uppercase tracking-wide mb-1">Author</div>
                                                <div class="text-sm text-secondary" x-text="item.author || '—'"></div>
                                            </div>
                                            <div>
                                                <div class="text-[10px] text-tertiary uppercase tracking-wide mb-1">Course</div>
                                                <div class="text-sm text-secondary" x-text="item.course || '—'"></div>
                                            </div>
                                            <div>
                                                <div class="text-[10px] text-tertiary uppercase tracking-wide mb-1">Component</div>
                                                <div class="text-sm text-secondary" x-text="item.component || '—'"></div>
                                            </div>
                                            <div>
                                                <div class="text-[10px] text-tertiary uppercase tracking-wide mb-1">Event Type</div>
                                                <div class="text-sm text-secondary" x-text="item.event_type || '—'"></div>
                                            </div>
                                        </div>

                                        <div>
                                            <div class="text-[10px] text-tertiary uppercase tracking-wide mb-1">Context URL</div>
                                            <a x-show="item.context_url"
                                               :href="item.context_url"
                                               target="_blank"
                                               rel="noopener"
                                               class="text-sm text-accent break-all hover:underline"
                                               x-text="item.context_url"></a>
                                            <div x-show="!item.context_url" class="text-sm text-secondary">—</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                        <div x-show="history.length === 0" class="px-5 py-6 text-center text-secondary">No notifications recorded yet.</div>
                    </div>
                </div>
            </section>

            <section id="configuration" class="flex flex-col gap-8 pb-20 pt-6 border-t border-white/5">
                <div class="flex flex-wrap justify-between items-center gap-4">
                    <div>
                        <h2 class="text-3xl font-medium text-primary">Settings</h2>
                        <p class="text-secondary text-sm mt-1">Manage connections and behavior</p>
                    </div>
                    <button @click="saveConfig" :disabled="saving" class="bg-accent text-accent-contrast px-5 py-2.5 rounded-full text-sm font-semibold hover:bg-accent-muted active:scale-95 transition-all disabled:opacity-40 flex items-center gap-2">
                        <span x-show="!saving">Save Changes</span>
                        <span x-show="saving">Saving...</span>
                    </button>
                </div>

                <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
                    <div class="bg-card-bg border border-border rounded-lg p-6">
                        <h2 class="text-lg font-medium mb-4 flex items-center gap-2">
                            <svg class="w-5 h-5 text-secondary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 10v6M2 10v6"/><path d="M22 16a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2"/><path d="M22 10a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2"/><rect x="2" y="6" width="20" height="8" rx="2"/></svg>
                            Moodle Connection
                        </h2>
                        <div class="grid grid-cols-1 gap-4">
                            <div>
                                <label class="block text-xs text-tertiary mb-1.5 uppercase tracking-wide">Moodle URL</label>
                                <input type="text" x-model="config.moodle.url" class="w-full bg-input border border-border rounded px-3 py-2 text-sm text-primary focus:border-accent focus:outline-none transition-colors" placeholder="https://moodle.example.edu">
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs text-tertiary mb-1.5 uppercase tracking-wide">Username</label>
                                    <input type="text" x-model="config.moodle.username" class="w-full bg-input border border-border rounded px-3 py-2 text-sm text-primary focus:border-accent focus:outline-none transition-colors">
                                </div>
                                <div>
                                    <label class="block text-xs text-tertiary mb-1.5 uppercase tracking-wide">Password</label>
                                    <input type="password" x-model="config.moodle.password" class="w-full bg-input border border-border rounded px-3 py-2 text-sm text-primary focus:border-accent focus:outline-none transition-colors" placeholder="••••••••">
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs text-tertiary mb-1.5 uppercase tracking-wide">Initial Fetch Count</label>
                                <div class="flex items-center bg-input border border-border rounded-lg overflow-hidden h-10">
                                    <button type="button" @click="config.moodle.initial_fetch_count = Math.max(1, (Number(config.moodle.initial_fetch_count) || 1) - 1)" class="h-full px-3 flex items-center justify-center text-secondary hover:text-primary hover:bg-white/5 border-r border-border transition-colors">
                                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path></svg>
                                    </button>
                                    <input type="text" inputmode="numeric" pattern="[0-9]*" x-model.number="config.moodle.initial_fetch_count" class="w-full h-full bg-transparent text-center text-sm text-primary focus:outline-none border-none">
                                    <button type="button" @click="config.moodle.initial_fetch_count = (Number(config.moodle.initial_fetch_count) || 1) + 1" class="h-full px-3 flex items-center justify-center text-secondary hover:text-primary hover:bg-white/5 border-l border-border transition-colors">
                                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-card-bg border border-border rounded-lg p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-lg font-medium flex items-center gap-2">
                                <svg class="w-5 h-5 text-secondary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a10 10 0 1 0 10 10H12V2z"/><path d="M12 2a10 10 0 0 1 10 10h-10V2z"/><path d="M12 12 2.1 12a10 10 0 0 1 9.9-10V12z"/></svg>
                                AI Processing
                            </h2>
                            <label class="inline-flex items-center cursor-pointer select-none">
                                <input type="checkbox" x-model="config.ai.enabled" class="sr-only peer">
                                <span class="toggle-track" aria-hidden="true">
                                    <span class="toggle-thumb"></span>
                                </span>
                            </label>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 transition-opacity duration-200" :class="{'opacity-40 pointer-events-none': !config.ai.enabled}">
                            <div class="md:col-span-2">
                                <label class="block text-xs text-tertiary mb-1.5 uppercase tracking-wide">Endpoint</label>
                                <input type="text" x-model="config.ai.endpoint" class="w-full bg-input border border-border rounded px-3 py-2 text-sm text-primary focus:border-accent focus:outline-none transition-colors">
                            </div>
                            <div>
                                <label class="block text-xs text-tertiary mb-1.5 uppercase tracking-wide">Model</label>
                                <input type="text" x-model="config.ai.model" class="w-full bg-input border border-border rounded px-3 py-2 text-sm text-primary focus:border-accent focus:outline-none transition-colors">
                            </div>
                            <div>
                                <label class="block text-xs text-tertiary mb-1.5 uppercase tracking-wide">API Key</label>
                                <input type="password" x-model="config.ai.api_key" class="w-full bg-input border border-border rounded px-3 py-2 text-sm text-primary focus:border-accent focus:outline-none transition-colors" placeholder="sk-...">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-xs text-tertiary mb-1.5 uppercase tracking-wide">System Prompt</label>
                                <textarea rows="2" x-model="config.ai.system_prompt" class="w-full bg-input border border-border rounded px-3 py-2 text-sm text-primary focus:border-accent focus:outline-none transition-colors resize-none"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="bg-card-bg border border-border rounded-lg p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-lg font-medium flex items-center gap-2">
                                <svg class="w-5 h-5 text-secondary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"/><path d="M9 18c-4.51 2-5-2-7-2"/></svg>
                                Discord Integration
                            </h2>
                            <label class="inline-flex items-center cursor-pointer select-none">
                                <input type="checkbox" x-model="config.discord.enabled" class="sr-only peer">
                                <span class="toggle-track" aria-hidden="true">
                                    <span class="toggle-thumb"></span>
                                </span>
                            </label>
                        </div>
                        <div class="grid grid-cols-1 gap-4 transition-opacity duration-200" :class="{'opacity-40 pointer-events-none': !config.discord.enabled}">
                            <div>
                                <label class="block text-xs text-tertiary mb-1.5 uppercase tracking-wide">Webhook URL</label>
                                <input type="password" x-model="config.discord.webhook_url" class="w-full bg-input border border-border rounded px-3 py-2 text-sm text-primary focus:border-accent focus:outline-none transition-colors">
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs text-tertiary mb-1.5 uppercase tracking-wide">Bot Name</label>
                                    <input type="text" x-model="config.discord.bot_name" class="w-full bg-input border border-border rounded px-3 py-2 text-sm text-primary focus:border-accent focus:outline-none transition-colors">
                                </div>
                                <div>
                                    <label class="block text-xs text-tertiary mb-1.5 uppercase tracking-wide">Avatar URL</label>
                                    <input type="text" x-model="config.discord.thumbnail_url" class="w-full bg-input border border-border rounded px-3 py-2 text-sm text-primary focus:border-accent focus:outline-none transition-colors">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-card-bg border border-border rounded-lg p-6 flex flex-col gap-6">
                        <div>
                            <h2 class="text-lg font-medium mb-4 flex items-center gap-2">
                                <svg class="w-5 h-5 text-secondary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="8" rx="2" ry="2"/><rect x="2" y="14" width="20" height="8" rx="2" ry="2"/><line x1="6" y1="6" x2="6.01" y2="6"/><line x1="6" y1="18" x2="6.01" y2="18"/></svg>
                                Web Server & Notification
                            </h2>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-xs text-tertiary mb-1.5 uppercase tracking-wide">Host</label>
                                    <input type="text" x-model="config.web.host" class="w-full bg-input border border-border rounded px-3 py-2 text-sm text-primary focus:border-accent focus:outline-none transition-colors">
                                </div>
                                <div>
                                    <label class="block text-xs text-tertiary mb-1.5 uppercase tracking-wide">Port</label>
                                    <input type="text" inputmode="numeric" pattern="[0-9]*" x-model.number="config.web.port" class="w-full bg-input border border-border rounded px-3 py-2 text-sm text-primary focus:border-accent focus:outline-none transition-colors">
                                </div>
                                <div>
                                    <label class="block text-xs text-tertiary mb-1.5 uppercase tracking-wide">Auth Secret</label>
                                    <input type="password" x-model="config.web.auth_secret" class="w-full bg-input border border-border rounded px-3 py-2 text-sm text-primary focus:border-accent focus:outline-none transition-colors">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4 pt-4 border-t border-border">
                                <div>
                                    <label class="block text-xs text-tertiary mb-1.5 uppercase tracking-wide">Fetch Interval (sec)</label>
                                    <input type="text" inputmode="numeric" pattern="[0-9]*" min="10" x-model.number="config.notification.fetch_interval" class="w-full bg-input border border-border rounded px-3 py-2 text-sm text-primary focus:border-accent focus:outline-none transition-colors" placeholder=">=10">
                                </div>
                                <div>
                                    <label class="block text-xs text-tertiary mb-1.5 uppercase tracking-wide">Max Retries</label>
                                    <input type="text" inputmode="numeric" pattern="[0-9]*" min="0" x-model.number="config.notification.max_retries" class="w-full bg-input border border-border rounded px-3 py-2 text-sm text-primary focus:border-accent focus:outline-none transition-colors" placeholder="0-10">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                                <div>
                                    <label class="block text-xs text-tertiary mb-1.5 uppercase tracking-wide">Connect Timeout (s)</label>
                                    <input type="text" inputmode="decimal" x-model.number="config.notification.connect_timeout" class="w-full bg-input border border-border rounded px-3 py-2 text-sm text-primary focus:border-accent focus:outline-none transition-colors" placeholder="<=60">
                                </div>
                                <div>
                                    <label class="block text-xs text-tertiary mb-1.5 uppercase tracking-wide">Read Timeout (s)</label>
                                    <input type="text" inputmode="decimal" x-model.number="config.notification.read_timeout" class="w-full bg-input border border-border rounded px-3 py-2 text-sm text-primary focus:border-accent focus:outline-none transition-colors" placeholder="<=180">
                                </div>
                                <div>
                                    <label class="block text-xs text-tertiary mb-1.5 uppercase tracking-wide">Max Payload (bytes)</label>
                                    <input type="text" inputmode="numeric" pattern="[0-9]*" x-model.number="config.notification.max_payload_bytes" class="w-full bg-input border border-border rounded px-3 py-2 text-sm text-primary focus:border-accent focus:outline-none transition-colors" placeholder="1024-262144">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                <div>
                                    <label class="block text-xs text-tertiary mb-1.5 uppercase tracking-wide">Retry Total</label>
                                    <input type="text" inputmode="numeric" pattern="[0-9]*" min="0" x-model.number="config.notification.retry_total" class="w-full bg-input border border-border rounded px-3 py-2 text-sm text-primary focus:border-accent focus:outline-none transition-colors" placeholder="0-10">
                                </div>
                                <div>
                                    <label class="block text-xs text-tertiary mb-1.5 uppercase tracking-wide">Retry Backoff Factor</label>
                                    <input type="text" inputmode="decimal" x-model.number="config.notification.retry_backoff_factor" class="w-full bg-input border border-border rounded px-3 py-2 text-sm text-primary focus:border-accent focus:outline-none transition-colors" placeholder="0-5">
                                </div>
                            </div>
                        </div>

                        <div class="border-t border-border pt-4">
                            <div class="flex items-center justify-between mb-4">
                                <span class="text-sm font-medium">Health Checks Enabled</span>
                                <label class="inline-flex items-center cursor-pointer select-none">
                                    <input type="checkbox" x-model="config.health.enabled" class="sr-only peer">
                                    <span class="toggle-track" aria-hidden="true">
                                        <span class="toggle-thumb"></span>
                                    </span>
                                </label>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 transition-opacity duration-200" :class="{'opacity-40 pointer-events-none': !config.health.enabled}">
                                <div>
                                    <label class="block text-xs text-tertiary mb-1.5 uppercase tracking-wide">Heartbeat (hrs)</label>
                                    <input type="text" inputmode="numeric" pattern="[0-9]*" x-model.number="config.health.heartbeat_interval" class="w-full bg-input border border-border rounded px-3 py-2 text-sm text-primary focus:border-accent focus:outline-none transition-colors">
                                </div>
                                <div>
                                    <label class="block text-xs text-tertiary mb-1.5 uppercase tracking-wide">Failure Threshold</label>
                                    <input type="text" inputmode="numeric" pattern="[0-9]*" x-model.number="config.health.failure_alert_threshold" class="w-full bg-input border border-border rounded px-3 py-2 text-sm text-primary focus:border-accent focus:outline-none transition-colors">
                                </div>
                                <div>
                                    <label class="block text-xs text-tertiary mb-1.5 uppercase tracking-wide">Target Provider</label>
                                    <input type="text" x-model="config.health.target_provider" class="w-full bg-input border border-border rounded px-3 py-2 text-sm text-primary focus:border-accent focus:outline-none transition-colors" placeholder="discord">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <footer class="text-xs text-secondary flex flex-wrap justify-between gap-2 border-t border-white/5 pt-4">
                <span>Moodle Mate <span x-text="version"></span></span>
                <span>Status: <span class="text-success" x-text="status.running ? 'Operational' : 'Paused'"></span></span>
            </footer>
        </div>
    </main>

    <div class="fixed bottom-6 right-6 z-50 flex flex-col gap-3 pointer-events-none">
        <template x-for="toast in toasts" :key="toast.id">
            <div x-show="toast.visible"
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="translate-y-2 opacity-0"
                 x-transition:enter-end="translate-y-0 opacity-100"
                 x-transition:leave="transition ease-in duration-200"
                 x-transition:leave-end="opacity-0 scale-95"
                 class="pointer-events-auto w-[300px] bg-card-bg border border-border rounded shadow-xl p-4 flex items-start gap-3">
                <div class="mt-1.5 h-1.5 w-1.5 rounded-full shrink-0" :class="toast.type === 'success' ? 'bg-green-500' : (toast.type === 'error' ? 'bg-red-500' : 'bg-blue-500')"></div>
                <div class="flex-1">
                    <h4 class="text-sm font-medium text-primary mb-1" x-text="toast.title"></h4>
                    <p class="text-xs text-secondary leading-relaxed" x-text="toast.message"></p>
                </div>
            </div>
        </template>
    </div>

    <script>
        const defaultConfigState = () => ({
            moodle: { url: "", username: "", password: "", initial_fetch_count: 1 },
            ai: { enabled: true, api_key: "", model: "gpt-5-nano", temperature: 0.7, max_tokens: 150, system_prompt: "", endpoint: "" },
            notification: { max_retries: 5, fetch_interval: 60, connect_timeout: 10, read_timeout: 30, retry_total: 3, retry_backoff_factor: 1, max_payload_bytes: 65536 },
            health: { enabled: false, heartbeat_interval: null, failure_alert_threshold: null, target_provider: "" },
            web: { enabled: true, host: "0.0.0.0", port: 9095, auth_secret: "" },
            discord: { enabled: false, webhook_url: "", bot_name: "MoodleMate", thumbnail_url: "" },
            webhook_site: { enabled: false, webhook_url: "", include_summary: true },
            pushbullet: { enabled: false, api_key: "", include_summary: true }
        });

        function dashboard() {
            return {
                status: { running: true, last_notification_id: null },
                config: defaultConfigState(),
                history: [],
                loading: false,
                saving: false,
                expandedId: null,
                toasts: [],
                currentTheme: "ember",
                themeNames: {
                    ember: "Ember Glow",
                    midnight: "Midnight Drift",
                    jade: "Jade Pulse",
                    kestral: "Kestral Dark"
                },
                themes: {
                    ember: {
                        "--color-bg": "#14120B",
                        "--color-card": "#1B1913",
                        "--color-border": "#2D281D",
                        "--color-border-hover": "#3A3426",
                        "--color-text": "#E8E2D4",
                        "--color-text-secondary": "#A89E8F",
                        "--color-text-tertiary": "#7F7566",
                        "--color-accent": "#F4B860",
                        "--color-accent-muted": "#DFA851",
                        "--color-accent-contrast": "#1A1510",
                        "--color-input": "#1E1A13",
                        "--color-success": "#10B981",
                        "--color-danger": "#4E1F1F",
                        "--color-scroll-track": "#14120B",
                        "--color-scroll-thumb": "#3A2C1F",
                        "--color-scroll-thumb-hover": "#4C3420"
                    },
                    midnight: {
                        "--color-bg": "#0D1117",
                        "--color-card": "#161B22",
                        "--color-border": "#2D333B",
                        "--color-border-hover": "#3E4450",
                        "--color-text": "#E6EDF3",
                        "--color-text-secondary": "#A6B3C1",
                        "--color-text-tertiary": "#7D8896",
                        "--color-accent": "#60A5FA",
                        "--color-accent-muted": "#3B82F6",
                        "--color-accent-contrast": "#05070A",
                        "--color-input": "#0F141A",
                        "--color-success": "#34D399",
                        "--color-danger": "#B91C1C",
                        "--color-scroll-track": "#0D1117",
                        "--color-scroll-thumb": "#2D333B",
                        "--color-scroll-thumb-hover": "#3E4450"
                    },
                    jade: {
                        "--color-bg": "#0E1C18",
                        "--color-card": "#152822",
                        "--color-border": "#1E352C",
                        "--color-border-hover": "#2A473D",
                        "--color-text": "#E4F2EC",
                        "--color-text-secondary": "#A5C7BB",
                        "--color-text-tertiary": "#6F8F85",
                        "--color-accent": "#34D399",
                        "--color-accent-muted": "#10B981",
                        "--color-accent-contrast": "#05120E",
                        "--color-input": "#11231D",
                        "--color-success": "#22C55E",
                        "--color-danger": "#DC2626",
                        "--color-scroll-track": "#0E1C18",
                        "--color-scroll-thumb": "#1F3A30",
                        "--color-scroll-thumb-hover": "#2E5044"
                    },
                    kestral: {
                        "--color-bg": "#141414",
                        "--color-card": "#181818",
                        "--color-border": "#2B2B2B",
                        "--color-border-hover": "#3C3C3C",
                        "--color-text": "#CCCCCC",
                        "--color-text-secondary": "#9D9D9D",
                        "--color-text-tertiary": "#616161",
                        "--color-accent": "#c586c0",
                        "--color-accent-muted": "#b06daa",
                        "--color-accent-contrast": "#FFFFFF",
                        "--color-input": "#313131",
                        "--color-success": "#2EA043",
                        "--color-danger": "#F85149",
                        "--color-scroll-track": "#141414",
                        "--color-scroll-thumb": "#2B2B2B",
                        "--color-scroll-thumb-hover": "#3C3C3C"
                    }
                },
                version: {{ version | tojson }},
                refreshTimer: null,

                async init() {
                    document.documentElement.classList.add("dark");
                    this.loadTheme();
                    this.applyConfigDefaults();
                    await this.refreshData();
                    this.refreshTimer = setInterval(() => this.refreshData(true), 15000);
                },

                defaultConfig() {
                    return defaultConfigState();
                },

                deepMerge(target, source) {
                    const output = Array.isArray(target) ? target.slice() : { ...target };
                    if (source && typeof source === "object") {
                        Object.keys(source).forEach((key) => {
                            const srcVal = source[key];
                            if (Array.isArray(srcVal)) {
                                output[key] = srcVal.slice();
                            } else if (srcVal && typeof srcVal === "object") {
                                output[key] = this.deepMerge(output[key] || {}, srcVal);
                            } else {
                                output[key] = srcVal;
                            }
                        });
                    }
                    return output;
                },

                applyConfigDefaults(newConfig = null) {
                    const merged = this.deepMerge(this.defaultConfig(), newConfig || this.config || {});
                    this.config = merged;
                },

                async parseResponse(res) {
                    if (!res) return null;
                    if (res.status === 401 || res.status === 307 || res.redirected) {
                        window.location.href = "/login";
                        return null;
                    }
                    if (res.status === 204) return null;
                    if (!res.ok) {
                        const message = await res.text();
                        throw new Error(message || "Request failed");
                    }
                    return res.json();
                },

                async refreshData(silent = false) {
                    if (!silent) this.loading = true;
                    try {
                        const [statusRes, configRes, historyRes] = await Promise.all([
                            fetch("/api/status"),
                            fetch("/api/config"),
                            fetch("/api/history")
                        ]);
                        const statusData = await this.parseResponse(statusRes);
                        const configData = await this.parseResponse(configRes);
                        const historyData = await this.parseResponse(historyRes);
                        if (statusData) this.status = statusData;
                        if (configData) this.applyConfigDefaults(configData);
                        if (historyData) this.history = historyData;
                    } catch (err) {
                        console.error(err);
                        if (!silent) this.showToast("Error", "Unable to refresh data.", "error");
                    } finally {
                        if (!silent) this.loading = false;
                    }
                },

                prepareConfigPayload() {
                    const payload = JSON.parse(JSON.stringify(this.config));
                    payload.moodle.initial_fetch_count = Number(payload.moodle.initial_fetch_count) || 1;
                    payload.notification.fetch_interval = Number(payload.notification.fetch_interval) || 60;
                    payload.notification.max_retries = Number(payload.notification.max_retries) || 5;
                    payload.notification.connect_timeout = Math.max(0.1, Number(payload.notification.connect_timeout) || 10);
                    payload.notification.read_timeout = Math.max(0.1, Number(payload.notification.read_timeout) || 30);
                    payload.notification.retry_total = Math.max(0, Math.floor(Number(payload.notification.retry_total) || 3));
                    payload.notification.retry_backoff_factor = Math.max(0, Number(payload.notification.retry_backoff_factor) || 1);
                    payload.notification.max_payload_bytes = Math.max(1024, Math.floor(Number(payload.notification.max_payload_bytes) || 65536));
                    payload.web.port = Number(payload.web.port) || 9095;
                    const heartbeat = payload.health.heartbeat_interval;
                    payload.health.heartbeat_interval = heartbeat === "" || heartbeat === null ? null : Number(heartbeat);
                    const failure = payload.health.failure_alert_threshold;
                    payload.health.failure_alert_threshold = failure === "" || failure === null ? null : Number(failure);
                    return payload;
                },

                async saveConfig() {
                    this.saving = true;
                    try {
                        const payload = this.prepareConfigPayload();
                        const res = await fetch("/api/config", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(payload)
                        });
                        if (!res.ok) {
                            let detail = "Failed to save config";
                            try {
                                const body = await res.json();
                                if (body?.detail) {
                                    detail = Array.isArray(body.detail)
                                        ? body.detail.map((d) => d.msg || JSON.stringify(d)).join("; ")
                                        : body.detail;
                                }
                            } catch (e) {
                                // ignore parse errors
                            }
                            throw new Error(detail);
                        }
                        this.showToast("Success", "Configuration saved successfully.", "success");
                        await this.refreshData(true);
                    } catch (err) {
                        console.error(err);
                        this.showToast("Error", err?.message || "Failed to save configuration.", "error");
                    } finally {
                        this.saving = false;
                    }
                },

                async triggerTestNotification() {
                    this.loading = true;
                    try {
                        const res = await fetch("/api/test-notification", { method: "POST" });
                        if (!res.ok) {
                            throw new Error("Request failed");
                        }
                        this.showToast("Notification Sent", "Test payload delivered.", "success");
                    } catch (err) {
                        console.error(err);
                        this.showToast("Error", "Failed to trigger notification.", "error");
                    } finally {
                        this.loading = false;
                    }
                },

                async logout() {
                    try {
                        await fetch("/api/logout", { method: "POST" });
                    } catch (err) {
                        console.error(err);
                    } finally {
                        window.location.href = "/login";
                    }
                },

                toggleExpand(id) {
                    this.expandedId = this.expandedId === id ? null : id;
                },

                formatDate(timestamp) {
                    if (timestamp === null || timestamp === undefined) return "N/A";
                    const numeric = Number(timestamp);
                    if (Number.isNaN(numeric)) return "N/A";
                    return new Date(numeric * 1000).toLocaleString();
                },

                loadTheme() {
                    const saved = localStorage.getItem("moodlemate_theme");
                    const nextTheme = saved && this.themes[saved] ? saved : "ember";
                    this.setTheme(nextTheme);
                },

                setTheme(name) {
                    if (!this.themes[name]) return;
                    this.currentTheme = name;
                    localStorage.setItem("moodlemate_theme", name);
                    const palette = this.themes[name];
                    const root = document.documentElement;
                    Object.entries(palette).forEach(([key, value]) => {
                        root.style.setProperty(key, value);
                    });
                },

                showToast(title, message, type = "info") {
                    const id = Date.now();
                    this.toasts.push({ id, title, message, type, visible: true });
                    setTimeout(() => {
                        const toast = this.toasts.find((t) => t.id === id);
                        if (toast) toast.visible = false;
                    }, 4000);
                }
            };
        }
    </script>
</body>
</html>

